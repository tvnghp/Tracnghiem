<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B√†i ki·ªÉm tra tr·∫Øc nghi·ªám Chi nh√°nh C·∫ßn Th∆° II</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  .modal {
    position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center;
    z-index: 9999;
  }
  .modal.hidden { display: none; }
  .modal-content {
    background: #fff; border-radius: 10px; padding: 32px 24px 24px 24px; box-shadow: 0 8px 32px rgba(128,0,32,0.13);
    max-width: 340px; text-align: center;
  }
  .modal-content h3 { margin-top: 0; color: #800020; }
  .modal-actions { margin-top: 22px; display: flex; gap: 16px; justify-content: center; }
  .modal-actions .btn { min-width: 120px; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="logo.png" alt="Logo" id="logo-img">
        <div class="logo-text">
          <h1><b>H·ªÜ TH·ªêNG TR·∫ÆC NGHI·ªÜM CHI NH√ÅNH C·∫¶N TH∆† II</b></h1>
          <p id="topic-name"></p>
        </div>
      </div>
      <div class="quiz-progress">
        <div id="progress-bar"></div>
        <div id="question-counter">C√¢u 1/10</div>
      </div>
    </header>    
    <div class="content">
      <div id="question-container">
        <div class="question-header">
          <div id="question" class="question"></div>
          <div class="question-meta">
            <span id="question-number">C√¢u 1/10</span>
            <button id="show-flagged-btn" class="btn btn-outline" title="Xem c√°c c√¢u ƒë√£ ƒë√°nh d·∫•u">
              <i class="material-icons">bookmark</i>
              <span id="flag-count">0</span>
            </button>
          </div>
        </div>
        <div id="answers" class="answers"></div>
        <div id="explanation" class="explanation"></div>
      </div>

      <div class="quiz-controls">
        <button id="prev-btn" class="btn btn-primary">
  <i class="material-icons">navigate_before</i> C√¢u tr∆∞·ªõc
</button>
        <div class="quiz-actions">
          <button id="flag-btn" class="btn btn-flag">
            <i class="material-icons">bookmark_border</i> ƒê√°nh d·∫•u
          </button>
          <button id="submit-quiz-btn" class="btn btn-danger">
            <i class="material-icons">send</i> N·ªôp b√†i
          </button>
        </div>
        <button id="next-btn" class="btn btn-primary">
          C√¢u ti·∫øp <i class="material-icons">navigate_next</i>
        </button>
      </div>

      <!-- Review Panel -->
      <div id="review-panel" class="review-panel">
        <div class="review-header">
          <h3><i class="material-icons">bookmark</i> C√°c c√¢u ƒë√£ ƒë√°nh d·∫•u</h3>
          <button id="close-review" class="btn btn-icon">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div id="flagged-questions" class="flagged-questions">
          <!-- Flagged questions will be inserted here -->
        </div>
      </div>

      <div id="result" class="result-panel"></div>
    </div>
  
<!-- Modal h·ªèi ti·∫øp t·ª•c session -->
  <div id="session-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Ti·∫øp t·ª•c b√†i ki·ªÉm tra?</h3>
        <p>B·∫°n ƒë√£ c√≥ m·ªôt phi√™n l√†m b√†i tr∆∞·ªõc ƒë√≥.<br>B·∫°n mu·ªën ti·∫øp t·ª•c hay b·∫Øt ƒë·∫ßu phi√™n m·ªõi?</p>
        <div class="modal-actions">
          <button id="resume-btn" class="btn btn-primary">Ti·∫øp t·ª•c phi√™n c≈©</button>
          <button id="new-session-btn" class="btn btn-outline">B·∫Øt ƒë·∫ßu m·ªõi</button>
        </div>
    </div>
  </div>
  <script>
    // DOM Elements
    const questionEl = document.getElementById('question');
    const answersEl = document.getElementById('answers');
    const progressEl = document.getElementById('progress-bar');
    const questionNumberEl = document.getElementById('question-number');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-quiz-btn');
    const flagBtn = document.getElementById('flag-btn');
    const showFlaggedBtn = document.getElementById('show-flagged-btn');
    const flagCountEl = document.getElementById('flag-count');
    const reviewPanel = document.getElementById('review-panel');
    const closeReviewBtn = document.getElementById('close-review');
    const flaggedQuestionsEl = document.getElementById('flagged-questions');
    const explanationEl = document.getElementById('explanation');
    const resultArea = document.getElementById('result');

    // Quiz state
    let topicId = null;
    let topics = [];
    let topic = null;
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let quizSubmitted = false;

    // Shuffle helpers
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function shuffleOptions(question) {
      const letterPool = ["A", "B", "C", "D"];
      const pairs = (question.optionLabels || []).map((label, idx) => ({
        label: label,
        text: question.options[idx]
      }));
      // determine correct option text before shuffling
      const correctIndex = (question.optionLabels || []).indexOf(question.answer);
      const correctText = correctIndex >= 0 ? question.options[correctIndex] : null;
      shuffleArray(pairs);
      // reassign labels A..D in new order and options accordingly
      question.optionLabels = pairs.map((_, idx) => letterPool[idx]);
      question.options = pairs.map(p => p.text);
      // set new correct label by matching text
      if (correctText !== null) {
        const newIndex = question.options.findIndex(t => t === correctText);
        if (newIndex >= 0) {
          question.answer = question.optionLabels[newIndex];
        }
      }
    }

    function shuffleQuestionsAndOptions() {
      // shuffle options within each question first
      questions.forEach(q => shuffleOptions(q));
      // then shuffle question order
      shuffleArray(questions);
    }

    // Initialize quiz
    async function initQuiz() {
  topicId = getTopicId();
  const progressKey = `quiz_progress_${topicId}`;
  const oldSession = localStorage.getItem(progressKey);

  if (oldSession) {
    // Hi·ªÉn th·ªã modal h·ªèi ng∆∞·ªùi d√πng
    const modal = document.getElementById('session-modal');
    modal.classList.remove('hidden');
    return new Promise(resolve => {
      document.getElementById('resume-btn').onclick = () => {
        modal.classList.add('hidden');
        resolve();
      };
      document.getElementById('new-session-btn').onclick = () => {
        localStorage.removeItem(progressKey);
        modal.classList.add('hidden');
        resolve();
      };
    }).then(() => continueInitQuiz());
  } else {
    continueInitQuiz();
  }
}

async function continueInitQuiz() {
  topics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
  topic = topics.find(t => t.id === topicId);

  if (!topic) {
    try {
      const url = new URL('./topics.json', location.href);
      url.searchParams.set('v', Date.now());
      const resp = await fetch(url, { cache: 'no-store' });
      if (resp.ok) {
        const remoteTopics = await resp.json();
        if (Array.isArray(remoteTopics) && remoteTopics.length > 0) {
          localStorage.setItem('quiz_topics', JSON.stringify(remoteTopics));
          topics = remoteTopics;
          topic = topics.find(t => t.id === topicId);
        }
      }
    } catch (e) {
      // ignore fetch errors and fall through to error display
    }
  }

  if (!topic) {
    showError('Kh√¥ng t√¨m th·∫•y chuy√™n ƒë·ªÅ!');
    return;
  }

  document.getElementById('topic-name').textContent = topic.name;
  questions = topic.questions || [];

  if (questions.length === 0) {
    showError('Chuy√™n ƒë·ªÅ n√†y ch∆∞a c√≥ c√¢u h·ªèi!');
    return;
  }

  // Shuffle questions and answers n·∫øu kh√¥ng c√≥ saved progress
  const hasSavedProgress = !!localStorage.getItem(`quiz_progress_${topicId}`);
  if (!hasSavedProgress) {
    shuffleQuestionsAndOptions();
  }

  // Initialize user answers
  userAnswers = questions.map((q, index) => ({
    answer: null,
    correct: null,
    flagged: false,
    explanationShown: false
  }));

  // Load saved progress n·∫øu c√≥
  loadProgress();

  // Initialize event listeners
  initEventListeners();

  // Show first question
  showQuestion(currentQuestionIndex);
}

    function loadProgress() {
      const savedProgress = localStorage.getItem(`quiz_progress_${topicId}`);
      if (savedProgress) {
        try {
          const progress = JSON.parse(savedProgress);
          if (progress.answers) userAnswers = progress.answers;
          if (progress.currentIndex !== undefined) currentQuestionIndex = progress.currentIndex;
          if (progress.quizSubmitted) quizSubmitted = progress.quizSubmitted;
        } catch (e) {
          console.error('Error loading progress:', e);
        }
      }
    }

    function saveProgress() {
      const progress = {
        answers: userAnswers,
        currentIndex: currentQuestionIndex,
        quizSubmitted: quizSubmitted,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem(`quiz_progress_${topicId}`, JSON.stringify(progress));
    }

    function showQuestion(index) {
      if (index < 0 || index >= questions.length) return;
      
      currentQuestionIndex = index;
      const question = questions[index];
      const userAnswer = userAnswers[index];
      
      // Update question number display
      questionNumberEl.textContent = `C√¢u ${index + 1}/${questions.length}`;
      
      // Update question text
      questionEl.textContent = question.question;
      
      // Update answers
      answersEl.innerHTML = '';
      question.optionLabels.forEach((label, i) => {
        const answer = question.options[i];
        const answerEl = document.createElement('div');
        const isSelected = userAnswer.answer === label;
        const isCorrect = label === question.answer;
        const reveal = quizSubmitted || userAnswer.answer !== null;
        
        let answerClass = 'answer';
        if (isSelected) answerClass += ' selected';
        if (reveal) {
          if (isCorrect) answerClass += ' correct';
          if (isSelected && !isCorrect) answerClass += ' incorrect';
        }
        
        answerEl.className = answerClass;
        answerEl.innerHTML = `
          <span class="option">${label}.</span>
          <span class="text">${answer}</span>
        `;
        
        if (!quizSubmitted || (quizSubmitted && !isSelected && !isCorrect)) {
          answerEl.onclick = () => selectAnswer(label);
        }
        
        answersEl.appendChild(answerEl);
      });

      // Update flag button
      updateFlagButton();
      
      // Show explanation if available and shown before
      if (userAnswer.explanationShown && question.explain) {
        showExplanation(question.explain);
      } else {
        explanationEl.style.display = 'none';
      }
      
      // Update navigation
      updateNavigation();
      updateProgress();
    }

    function updateFlagButton() {
      const isFlagged = userAnswers[currentQuestionIndex].flagged;
      flagBtn.innerHTML = `
        <i class="material-icons">${isFlagged ? 'bookmark' : 'bookmark_border'}</i>
        ${isFlagged ? 'B·ªè ƒë√°nh d·∫•u' : 'ƒê√°nh d·∫•u'}
      `;
      flagBtn.classList.toggle('active', isFlagged);
      
      // Update flag count
      const flagCount = userAnswers.filter(a => a.flagged).length;
      flagCountEl.textContent = flagCount > 0 ? flagCount : '';
      showFlaggedBtn.style.display = flagCount > 0 ? 'flex' : 'none';
    }

    function updateNavigation() {
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.disabled = currentQuestionIndex === questions.length - 1;
      
      // Submit is always available
      submitBtn.style.display = 'inline-flex';
      
      // Hide next on last question
      if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'inline-flex';
      }
    }

    function updateProgress() {
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      progressEl.style.width = `${progress}%`;
    }

    function selectAnswer(answer) {
      if (quizSubmitted) return;
      
      const userAnswer = userAnswers[currentQuestionIndex];
      userAnswer.answer = answer;
      userAnswer.correct = answer === questions[currentQuestionIndex].answer;
      
      // Show explanation if available
      const question = questions[currentQuestionIndex];
      if (question.explain) {
        showExplanation(question.explain);
        userAnswer.explanationShown = true;
      }
      
      // Update UI
      showQuestion(currentQuestionIndex);
      saveProgress();
    }

    function showExplanation(text) {
      explanationEl.innerHTML = `
        <h4><i class="material-icons">info</i> Gi·∫£i th√≠ch</h4>
        <p>${text}</p>
      `;
      explanationEl.style.display = 'block';
    }

    function toggleFlag() {
      userAnswers[currentQuestionIndex].flagged = !userAnswers[currentQuestionIndex].flagged;
      updateFlagButton();
      saveProgress();
    }

    function showFlaggedQuestions() {
      const flaggedIndices = [];
      userAnswers.forEach((ua, index) => {
        if (ua.flagged) flaggedIndices.push(index);
      });
      
      if (flaggedIndices.length === 0) {
        flaggedQuestionsEl.innerHTML = '<p class="no-flagged">Kh√¥ng c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c ƒë√°nh d·∫•u</p>';
      } else {
        const flaggedList = flaggedIndices.map(index => {
          const q = questions[index];
          const ua = userAnswers[index];
          const isCorrect = ua.answer === q.answer;
          
          return `
            <div class="flagged-question" data-index="${index}">
              <div class="question">${index + 1}. ${q.question}</div>
              <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}">
                ${isCorrect ? '‚úì ƒê√£ tr·∫£ l·ªùi ƒë√∫ng' : '‚úó Ch∆∞a tr·∫£ l·ªùi'}
              </div>
              ${quizSubmitted && q.explain ? `
                <div class="explanation">
                  <strong>Gi·∫£i th√≠ch:</strong> ${q.explain}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
        
        flaggedQuestionsEl.innerHTML = flaggedList;
        
        // Add click handler to flagged questions
        document.querySelectorAll('.flagged-question').forEach(item => {
          item.addEventListener('click', () => {
            const index = parseInt(item.dataset.index);
            currentQuestionIndex = index;
            showQuestion(index);
            reviewPanel.classList.remove('show');
            document.body.style.overflow = 'auto';
          });
        });
      }
      
      // Show review panel
      reviewPanel.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function submitQuiz() {
      if (quizSubmitted) return;
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?')) {
        quizSubmitted = true;
        showResults();
        saveProgress();
      }
    }

    function showResults() {
      const correctCount = userAnswers.filter(a => a.correct).length;
      const totalQuestions = questions.length;
      const score = Math.round((correctCount / totalQuestions) * 100);
      
      resultArea.innerHTML = `
        <div class="result-container">
          <h2>K·∫øt qu·∫£ b√†i ki·ªÉm tra</h2>
          <div class="score-display">
            <div class="score">${correctCount}<span>/${totalQuestions}</span></div>
            <div class="percentage">${score}%</div>
          </div>
          <div class="result-actions">
            <a href="index.html" class="btn">
              <i class="material-icons">home</i> V·ªÅ trang ch·ªß
            </a>
            <button id="restart-btn" class="btn btn-outline">
              <i class="material-icons">refresh</i> L√†m l·∫°i
            </button>
          </div>
        </div>
      `;
      resultArea.style.display = 'block';
      
      // Attach restart handler once results are shown
      const restartBtn = document.getElementById('restart-btn');
      if (restartBtn) {
        restartBtn.addEventListener('click', () => {
          // Clear quiz progress and reset state to the very beginning
          localStorage.removeItem(`quiz_progress_${topicId}`);
          quizSubmitted = false;
          // Shuffle fresh for a new attempt
          shuffleQuestionsAndOptions();
          userAnswers = questions.map(() => ({
            answer: null,
            correct: null,
            flagged: false,
            explanationShown: false
          }));
          currentQuestionIndex = 0;
          resultArea.innerHTML = '';
          resultArea.style.display = 'none';
          showQuestion(0);
          saveProgress();
        }, { once: true });
      }
      
      // Show all explanations for review
      questions.forEach((q, index) => {
        if (q.explain) {
          userAnswers[index].explanationShown = true;
        }
      });
      
      // Show first question with explanations
      showQuestion(0);
    }

    function initEventListeners() {
      // Navigation
      prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
          showQuestion(currentQuestionIndex - 1);
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentQuestionIndex < questions.length - 1) {
          showQuestion(currentQuestionIndex + 1);
        }
      });

      // Submit quiz
      submitBtn.addEventListener('click', submitQuiz);
      
      // Flag question
      flagBtn.addEventListener('click', toggleFlag);
      
      // Show flagged questions
      showFlaggedBtn.addEventListener('click', showFlaggedQuestions);
      
      // Close review panel
      closeReviewBtn.addEventListener('click', () => {
        reviewPanel.classList.remove('show');
        document.body.style.overflow = 'auto';
      });
      
      // Close review panel when clicking outside
      reviewPanel.addEventListener('click', (e) => {
        if (e.target === reviewPanel) {
          reviewPanel.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
          showQuestion(currentQuestionIndex - 1);
        } else if (e.key === 'ArrowRight' && currentQuestionIndex < questions.length - 1) {
          showQuestion(currentQuestionIndex + 1);
        } else if (e.key === ' ' || e.key === 'Enter') {
          if (!e.target.matches('button, a, input, textarea')) {
            e.preventDefault();
            const selected = document.querySelector('.answer:not(.selected)');
            if (selected) selected.click();
          }
        } else if (e.key === 'f' || e.key === 'F') {
          e.preventDefault();
          toggleFlag();
        } else if (e.key === 'Escape') {
          reviewPanel.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      });
    }

    function getTopicId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('topic');
    }

    function showError(message) {
      document.body.innerHTML = `
        <div class="error-message">
          <h2>${message}</h2>
          <p>Vui l√≤ng quay l·∫°i trang ch·ªß v√† th·ª≠ l·∫°i.</p>
          <a href="index.html" class="btn">
            <i class="material-icons">home</i> V·ªÅ trang ch·ªß
          </a>
        </div>
      `;
    }

    // Initialize the quiz
    document.addEventListener('DOMContentLoaded', initQuiz);
  </script>
  <footer class="footer-copyright">
  B·∫£n quy·ªÅn ¬© 2025 H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám Agribank Chi nh√°nh C·∫ßn Th∆° II.<br>  
Li√™n h·ªá: Nguy·ªÖn Th√†nh Trung üì± Cellphone: 0947.86.86.82<br>üìß Email: trungnguyenthanh1@agribank.com.vn
</footer>
</body>
</html>

