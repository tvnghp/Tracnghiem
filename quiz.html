<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bài kiểm tra trắc nghiệm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="logo.png" alt="Logo" id="logo-img">
        <div class="logo-text">
          <h1>Bài kiểm tra trắc nghiệm</h1>
          <p id="topic-name"></p>
        </div>
      </div>
      <div class="quiz-progress">
        <div id="progress-bar"></div>
        <div id="question-counter">Câu 1/10</div>
      </div>
    </header>

    <div class="content">
      <div id="question-container">
        <div class="question-header">
          <div id="question" class="question"></div>
          <div class="question-meta">
            <span id="question-number">Câu 1/10</span>
            <button id="show-flagged-btn" class="btn btn-outline" title="Xem các câu đã đánh dấu">
              <i class="material-icons">bookmark</i>
              <span id="flag-count">0</span>
            </button>
          </div>
        </div>
        <div id="answers" class="answers"></div>
        <div id="explanation" class="explanation"></div>
      </div>

      <div class="quiz-controls">
        <button id="prev-btn" class="btn btn-outline">
          <i class="material-icons">navigate_before</i> Câu trước
        </button>
        <div class="quiz-actions">
          <button id="flag-btn" class="btn btn-flag">
            <i class="material-icons">bookmark_border</i> Đánh dấu
          </button>
          <button id="submit-quiz-btn" class="btn btn-danger">
            <i class="material-icons">send</i> Nộp bài
          </button>
        </div>
        <button id="next-btn" class="btn btn-primary">
          Câu tiếp <i class="material-icons">navigate_next</i>
        </button>
      </div>

      <!-- Review Panel -->
      <div id="review-panel" class="review-panel">
        <div class="review-header">
          <h3><i class="material-icons">bookmark</i> Các câu đã đánh dấu</h3>
          <button id="close-review" class="btn btn-icon">
            <i class="material-icons">close</i>
          </button>
        </div>
        <div id="flagged-questions" class="flagged-questions">
          <!-- Flagged questions will be inserted here -->
        </div>
      </div>

      <div id="result" class="result-panel"></div>
    </div>
  </div>

  <script>
    // DOM Elements
    const questionEl = document.getElementById('question');
    const answersEl = document.getElementById('answers');
    const progressEl = document.getElementById('progress-bar');
    const questionNumberEl = document.getElementById('question-number');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-quiz-btn');
    const flagBtn = document.getElementById('flag-btn');
    const showFlaggedBtn = document.getElementById('show-flagged-btn');
    const flagCountEl = document.getElementById('flag-count');
    const reviewPanel = document.getElementById('review-panel');
    const closeReviewBtn = document.getElementById('close-review');
    const flaggedQuestionsEl = document.getElementById('flagged-questions');
    const explanationEl = document.getElementById('explanation');
    const resultArea = document.getElementById('result');

    // Quiz state
    let topicId = null;
    let topics = [];
    let topic = null;
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let quizSubmitted = false;

    // Initialize quiz
    async function initQuiz() {
      // Load topic from localStorage or fallback to topics.json
      topicId = getTopicId();
      topics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
      topic = topics.find(t => t.id === topicId);
      
      if (!topic) {
        try {
          const resp = await fetch('topics.json', { cache: 'no-store' });
          if (resp.ok) {
            const remoteTopics = await resp.json();
            if (Array.isArray(remoteTopics) && remoteTopics.length > 0) {
              localStorage.setItem('quiz_topics', JSON.stringify(remoteTopics));
              topics = remoteTopics;
              topic = topics.find(t => t.id === topicId);
            }
          }
        } catch (e) {
          // ignore fetch errors and fall through to error display
        }
      }
      
      if (!topic) {
        showError('Không tìm thấy chuyên đề!');
        return;
      }

      document.getElementById('topic-name').textContent = topic.name;
      questions = topic.questions || [];
      
      if (questions.length === 0) {
        showError('Chuyên đề này chưa có câu hỏi!');
        return;
      }

      // Initialize user answers
      userAnswers = questions.map((q, index) => ({
        answer: null,
        correct: null,
        flagged: false,
        explanationShown: false
      }));

      // Load saved progress if exists
      loadProgress();
      
      // Initialize event listeners
      initEventListeners();
      
      // Show first question
      showQuestion(currentQuestionIndex);
    }

    function loadProgress() {
      const savedProgress = localStorage.getItem(`quiz_progress_${topicId}`);
      if (savedProgress) {
        try {
          const progress = JSON.parse(savedProgress);
          if (progress.answers) userAnswers = progress.answers;
          if (progress.currentIndex !== undefined) currentQuestionIndex = progress.currentIndex;
          if (progress.quizSubmitted) quizSubmitted = progress.quizSubmitted;
        } catch (e) {
          console.error('Error loading progress:', e);
        }
      }
    }

    function saveProgress() {
      const progress = {
        answers: userAnswers,
        currentIndex: currentQuestionIndex,
        quizSubmitted: quizSubmitted,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem(`quiz_progress_${topicId}`, JSON.stringify(progress));
    }

    function showQuestion(index) {
      if (index < 0 || index >= questions.length) return;
      
      currentQuestionIndex = index;
      const question = questions[index];
      const userAnswer = userAnswers[index];
      
      // Update question number display
      questionNumberEl.textContent = `Câu ${index + 1}/${questions.length}`;
      
      // Update question text
      questionEl.textContent = question.question;
      
      // Update answers
      answersEl.innerHTML = '';
      question.optionLabels.forEach((label, i) => {
        const answer = question.options[i];
        const answerEl = document.createElement('div');
        const isSelected = userAnswer.answer === label;
        const isCorrect = label === question.answer;
        
        let answerClass = 'answer';
        if (isSelected) answerClass += ' selected';
        if (quizSubmitted) {
          if (isCorrect) answerClass += ' correct';
          if (isSelected && !isCorrect) answerClass += ' incorrect';
        }
        
        answerEl.className = answerClass;
        answerEl.innerHTML = `
          <span class="option">${label}.</span>
          <span class="text">${answer}</span>
        `;
        
        if (!quizSubmitted || (quizSubmitted && !isSelected && !isCorrect)) {
          answerEl.onclick = () => selectAnswer(label);
        }
        
        answersEl.appendChild(answerEl);
      });

      // Update flag button
      updateFlagButton();
      
      // Show explanation if available and shown before
      if (userAnswer.explanationShown && question.explain) {
        showExplanation(question.explain);
      } else {
        explanationEl.style.display = 'none';
      }
      
      // Update navigation
      updateNavigation();
      updateProgress();
    }

    function updateFlagButton() {
      const isFlagged = userAnswers[currentQuestionIndex].flagged;
      flagBtn.innerHTML = `
        <i class="material-icons">${isFlagged ? 'bookmark' : 'bookmark_border'}</i>
        ${isFlagged ? 'Bỏ đánh dấu' : 'Đánh dấu'}
      `;
      flagBtn.classList.toggle('active', isFlagged);
      
      // Update flag count
      const flagCount = userAnswers.filter(a => a.flagged).length;
      flagCountEl.textContent = flagCount > 0 ? flagCount : '';
      showFlaggedBtn.style.display = flagCount > 0 ? 'flex' : 'none';
    }

    function updateNavigation() {
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.disabled = currentQuestionIndex === questions.length - 1;
      
      // Submit is always available
      submitBtn.style.display = 'inline-flex';
      
      // Hide next on last question
      if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = 'inline-flex';
      }
    }

    function updateProgress() {
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      progressEl.style.width = `${progress}%`;
    }

    function selectAnswer(answer) {
      if (quizSubmitted) return;
      
      const userAnswer = userAnswers[currentQuestionIndex];
      userAnswer.answer = answer;
      userAnswer.correct = answer === questions[currentQuestionIndex].answer;
      
      // Show explanation if available
      const question = questions[currentQuestionIndex];
      if (question.explain) {
        showExplanation(question.explain);
        userAnswer.explanationShown = true;
      }
      
      // Update UI
      showQuestion(currentQuestionIndex);
      saveProgress();
    }

    function showExplanation(text) {
      explanationEl.innerHTML = `
        <h4><i class="material-icons">info</i> Giải thích</h4>
        <p>${text}</p>
      `;
      explanationEl.style.display = 'block';
    }

    function toggleFlag() {
      userAnswers[currentQuestionIndex].flagged = !userAnswers[currentQuestionIndex].flagged;
      updateFlagButton();
      saveProgress();
    }

    function showFlaggedQuestions() {
      const flaggedIndices = [];
      userAnswers.forEach((ua, index) => {
        if (ua.flagged) flaggedIndices.push(index);
      });
      
      if (flaggedIndices.length === 0) {
        flaggedQuestionsEl.innerHTML = '<p class="no-flagged">Không có câu hỏi nào được đánh dấu</p>';
      } else {
        const flaggedList = flaggedIndices.map(index => {
          const q = questions[index];
          const ua = userAnswers[index];
          const isCorrect = ua.answer === q.answer;
          
          return `
            <div class="flagged-question" data-index="${index}">
              <div class="question">${index + 1}. ${q.question}</div>
              <div class="answer-status ${isCorrect ? 'correct' : 'incorrect'}">
                ${isCorrect ? '✓ Đã trả lời đúng' : '✗ Chưa trả lời'}
              </div>
              ${quizSubmitted && q.explain ? `
                <div class="explanation">
                  <strong>Giải thích:</strong> ${q.explain}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
        
        flaggedQuestionsEl.innerHTML = flaggedList;
        
        // Add click handler to flagged questions
        document.querySelectorAll('.flagged-question').forEach(item => {
          item.addEventListener('click', () => {
            const index = parseInt(item.dataset.index);
            currentQuestionIndex = index;
            showQuestion(index);
            reviewPanel.classList.remove('show');
            document.body.style.overflow = 'auto';
          });
        });
      }
      
      // Show review panel
      reviewPanel.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function submitQuiz() {
      if (quizSubmitted) return;
      if (confirm('Bạn có chắc chắn muốn nộp bài không?')) {
        quizSubmitted = true;
        showResults();
        saveProgress();
      }
    }

    function showResults() {
      const correctCount = userAnswers.filter(a => a.correct).length;
      const totalQuestions = questions.length;
      const score = Math.round((correctCount / totalQuestions) * 100);
      
      resultArea.innerHTML = `
        <div class="result-container">
          <h2>Kết quả bài kiểm tra</h2>
          <div class="score-display">
            <div class="score">${correctCount}<span>/${totalQuestions}</span></div>
            <div class="percentage">${score}%</div>
          </div>
          <div class="result-actions">
            <a href="index.html" class="btn">
              <i class="material-icons">home</i> Về trang chủ
            </a>
            <button id="restart-btn" class="btn btn-outline">
              <i class="material-icons">refresh</i> Làm lại
            </button>
          </div>
        </div>
      `;
      resultArea.style.display = 'block';
      
      // Attach restart handler once results are shown
      const restartBtn = document.getElementById('restart-btn');
      if (restartBtn) {
        restartBtn.addEventListener('click', () => {
          // Clear quiz progress and reset state to the very beginning
          localStorage.removeItem(`quiz_progress_${topicId}`);
          quizSubmitted = false;
          userAnswers = questions.map(() => ({
            answer: null,
            correct: null,
            flagged: false,
            explanationShown: false
          }));
          currentQuestionIndex = 0;
          resultArea.innerHTML = '';
          resultArea.style.display = 'none';
          showQuestion(0);
          saveProgress();
        }, { once: true });
      }
      
      // Show all explanations for review
      questions.forEach((q, index) => {
        if (q.explain) {
          userAnswers[index].explanationShown = true;
        }
      });
      
      // Show first question with explanations
      showQuestion(0);
    }

    function initEventListeners() {
      // Navigation
      prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
          showQuestion(currentQuestionIndex - 1);
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentQuestionIndex < questions.length - 1) {
          showQuestion(currentQuestionIndex + 1);
        }
      });

      // Submit quiz
      submitBtn.addEventListener('click', submitQuiz);
      
      // Flag question
      flagBtn.addEventListener('click', toggleFlag);
      
      // Show flagged questions
      showFlaggedBtn.addEventListener('click', showFlaggedQuestions);
      
      // Close review panel
      closeReviewBtn.addEventListener('click', () => {
        reviewPanel.classList.remove('show');
        document.body.style.overflow = 'auto';
      });
      
      // Close review panel when clicking outside
      reviewPanel.addEventListener('click', (e) => {
        if (e.target === reviewPanel) {
          reviewPanel.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
          showQuestion(currentQuestionIndex - 1);
        } else if (e.key === 'ArrowRight' && currentQuestionIndex < questions.length - 1) {
          showQuestion(currentQuestionIndex + 1);
        } else if (e.key === ' ' || e.key === 'Enter') {
          if (!e.target.matches('button, a, input, textarea')) {
            e.preventDefault();
            const selected = document.querySelector('.answer:not(.selected)');
            if (selected) selected.click();
          }
        } else if (e.key === 'f' || e.key === 'F') {
          e.preventDefault();
          toggleFlag();
        } else if (e.key === 'Escape') {
          reviewPanel.classList.remove('show');
          document.body.style.overflow = 'auto';
        }
      });
    }

    function getTopicId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('topic');
    }

    function showError(message) {
      document.body.innerHTML = `
        <div class="error-message">
          <h2>${message}</h2>
          <p>Vui lòng quay lại trang chủ và thử lại.</p>
          <a href="index.html" class="btn">
            <i class="material-icons">home</i> Về trang chủ
          </a>
        </div>
      `;
    }

    // Initialize the quiz
    document.addEventListener('DOMContentLoaded', initQuiz);
  </script>
</body>
</html>