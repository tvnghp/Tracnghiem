<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Bài kiểm tra trắc nghiệm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="logo.png" alt="Logo" id="logo-img">
        <div class="logo-text">
          <h1>Bài kiểm tra trắc nghiệm</h1>
          <p id="topic-name"></p>
        </div>
      </div>
      <div class="quiz-progress">
        <div id="progress-bar"></div>
        <div id="question-counter">Câu 1/10</div>
      </div>
    </header>

    <div class="content">
      <div id="question-container">
        <div id="question" class="question"></div>
        <div id="answers" class="answers"></div>
      </div>

      <div class="quiz-controls">
        <button id="prev-btn" class="btn btn-outline">
          <i class="material-icons">navigate_before</i> Câu trước
        </button>
        <div class="quiz-actions">
          <button id="flag-btn" class="btn btn-flag">
            <i class="material-icons">flag</i> Đánh dấu
          </button>
          <button id="submit-btn" class="btn btn-primary">
            Nộp bài <i class="material-icons">send</i>
          </button>
        </div>
        <button id="next-btn" class="btn btn-primary">
          Câu tiếp <i class="material-icons">navigate_next</i>
        </button>
      </div>

      <div id="result" class="result-panel"></div>
    </div>
  </div>

  <script>
    function getTopicId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('topic');
    }

    let topicId = getTopicId();
    let topics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
    let topic = topics.find(t => t.id === topicId);
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    
    // Initialize quiz
    function initQuiz() {
      if (!topic) {
        showError('Không tìm thấy chuyên đề!');
        return;
      }

      document.getElementById('topic-name').textContent = topic.name;
      questions = topic.questions || [];
      
      if (questions.length === 0) {
        showError('Chuyên đề này chưa có câu hỏi!');
        return;
      }

      // Initialize user answers
      userAnswers = questions.map(() => ({
        answer: null,
        correct: null,
        flagged: false
      }));

      // Show first question
      showQuestion(0);
      updateProgress();
    }

    // Show error message
    function showError(message) {
      document.body.innerHTML = `
        <div class="container">
          <div class="error-message">
            <h2>${message}</h2>
            <p>Vui lòng quay lại trang chủ và thử lại.</p>
            <a href="index.html" class="btn">
              <i class="material-icons">home</i> Về trang chủ
            </a>
          </div>
        </div>`;
    }

    // Show question at index
    function showQuestion(index) {
      if (index < 0 || index >= questions.length) return;
      
      currentQuestionIndex = index;
      const question = questions[index];
      const userAnswer = userAnswers[index];

      // Update question text
      questionEl.textContent = `${index + 1}. ${question.question}`;
      
      // Update answers
      answersEl.innerHTML = '';
      question.optionLabels.forEach((label, i) => {
        const answer = question.options[i];
        const answerEl = document.createElement('div');
        answerEl.className = 'answer' + (userAnswer.answer === label ? ' selected' : '');
        answerEl.innerHTML = `
          <span class="option">${label}.</span>
          <span class="text">${answer}</span>
        `;
        answerEl.onclick = () => selectAnswer(label);
        answersEl.appendChild(answerEl);
      });

      // Update navigation buttons
      prevBtn.disabled = index === 0;
      nextBtn.disabled = index === questions.length - 1;
      nextBtn.style.display = index === questions.length - 1 ? 'none' : 'inline-flex';
      submitBtn.style.display = index === questions.length - 1 ? 'inline-flex' : 'none';
      
      // Update flag button
      flagBtn.className = `btn btn-flag ${userAnswer.flagged ? 'active' : ''}`;
      
      // Update progress
      updateProgress();
    }

    // Update progress bar and counter
    function updateProgress() {
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      progressEl.style.width = `${progress}%`;
      questionCounterEl.textContent = `Câu ${currentQuestionIndex + 1}/${questions.length}`;
    }

    // Handle answer selection
    function selectAnswer(answer) {
      const currentAnswer = userAnswers[currentQuestionIndex];
      currentAnswer.answer = answer;
      currentAnswer.correct = answer === questions[currentQuestionIndex].answer;
      
      // Update UI
      const answerEls = document.querySelectorAll('.answer');
      answerEls.forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
    }

    // Toggle flag for current question
    function toggleFlag() {
      userAnswers[currentQuestionIndex].flagged = !userAnswers[currentQuestionIndex].flagged;
      flagBtn.classList.toggle('active');
    }

    // Show quiz results
    function showResults() {
      const score = userAnswers.filter(a => a.correct).length;
      const total = questions.length;
      const percentage = Math.round((score / total) * 100);
      
      resultArea.innerHTML = `
        <h2>Kết quả bài kiểm tra</h2>
        <div class="score">
          <div class="score-number">${score}/${total}</div>
          <div class="score-percentage">${percentage}%</div>
        </div>
        <div class="actions">
          <button onclick="window.location.href='index.html'" class="btn">
            <i class="material-icons">home</i> Về trang chủ
          </button>
          <button onclick="window.location.reload()" class="btn btn-outline">
            <i class="material-icons">refresh</i> Làm lại
          </button>
        </div>
      `;
      
      quizArea.style.display = 'none';
      resultArea.style.display = 'block';
    }

    // Event listeners
    prevBtn.addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        showQuestion(currentQuestionIndex - 1);
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentQuestionIndex < questions.length - 1) {
        showQuestion(currentQuestionIndex + 1);
      }
    });

    submitBtn.addEventListener('click', showResults);
    flagBtn.addEventListener('click', toggleFlag);

    // Initialize the quiz
    document.addEventListener('DOMContentLoaded', initQuiz);
  </script>
</body>
</html>