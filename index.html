<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám Chi nh√°nh C·∫ßn Th∆° II</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="mobile-enhancements.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Theme and PWA meta tags -->
  <meta name="theme-color" content="#800020">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  
  <!-- iOS specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Quiz C·∫ßn Th∆° II">
  <meta name="apple-touch-fullscreen" content="yes">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
  
  <!-- Android specific meta tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Quiz C·∫ßn Th∆° II">
  <meta name="msapplication-TileColor" content="#800020">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- Android Chrome specific -->
  <meta name="theme-color" content="#800020" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#800020" media="(prefers-color-scheme: dark)">
  
  <!-- Manifest and icons -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="logo.png">
  <link rel="icon" type="image/png" sizes="512x512" href="logo.png">
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* iPhone specific optimizations */
    @supports (-webkit-touch-callout: none) {
      body {
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: 100%;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        border-radius: 0;
      }
      
      button {
        -webkit-appearance: none;
        -webkit-tap-highlight-color: transparent;
      }
    }
    
    /* Android specific optimizations */
    @supports not (-webkit-touch-callout: none) {
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border-radius: 8px;
      }
      
      button {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -webkit-tap-highlight-color: transparent;
        -moz-tap-highlight-color: transparent;
        tap-highlight-color: transparent;
      }
      
      /* Android Chrome specific optimizations */
      .container {
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
      }
      
      /* Better touch targets for Android */
      .btn, .answer, .topic-card {
        min-height: 48px;
        min-width: 48px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="logo.png" alt="Logo" id="logo-img">
        <div class="logo-text">
          <h1>H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám</h1>
          <p>Chi nh√°nh C·∫ßn Th∆° II</p>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="welcome-section">
        <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II</h2>
        <p>Ch·ªçn chuy√™n m·ª•c ph√π h·ª£p b√™n d∆∞·ªõi:</p>
      </div>

      <section class="mt-4">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">Chuy√™n ƒë·ªÅ (kh√¥ng gi·ªõi h·∫°n th·ªùi gian)</h3>
          <button id="topic-view-toggle" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">
            <i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi
          </button>
        </div>
        
        <!-- Dropdown View -->
        <div id="topic-dropdown-view">
          <div class="form-group">
            <label for="topic-select">Ch·ªçn chuy√™n ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu</label>
            <select id="topic-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4a5a5; font-size: 1rem;">
              <option value="">-- Ch·ªçn chuy√™n ƒë·ªÅ --</option>
            </select>
          </div>
          <div id="topic-info" style="display: none; margin-top: 16px; padding: 16px; background: #f8f6f8; border-radius: 8px; border-left: 4px solid #800020;">
            <p id="topic-description" style="margin: 0 0 12px; color: #666;"></p>
            <a id="topic-start-btn" href="#" class="btn" style="display: inline-flex;">
              <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
            </a>
          </div>
        </div>
        
        <!-- Grid View -->
        <div id="topic-grid-view" style="display: none;">
          <div id="topics-container" class="topics-grid"></div>
        </div>
      </section>

      <section class="mt-4">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">B√†i thi (c√≥ th·ªùi gian)</h3>
          <button id="exam-view-toggle" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">
            <i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi
          </button>
        </div>
        
        <!-- Dropdown View -->
        <div id="exam-dropdown-view">
          <div class="form-group">
            <label for="exam-select">Ch·ªçn b√†i thi ƒë·ªÉ b·∫Øt ƒë·∫ßu</label>
            <select id="exam-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4a5a5; font-size: 1rem;">
              <option value="">-- Ch·ªçn b√†i thi --</option>
            </select>
          </div>
          <div id="exam-info" style="display: none; margin-top: 16px; padding: 16px; background: #f8f6f8; border-radius: 8px; border-left: 4px solid #800020;">
            <p id="exam-description" style="margin: 0 0 12px; color: #666;"></p>
            <a id="exam-start-btn" href="#" class="btn" style="display: inline-flex;">
              <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu thi
            </a>
          </div>
        </div>
        
        <!-- Grid View -->
        <div id="exam-grid-view" style="display: none;">
          <div id="exams-container" class="topics-grid"></div>
        </div>
      </section>

      <div class="admin-section">
        <a href="admin.html" class="btn btn-outline">
          <i class="material-icons">admin_panel_settings</i> Qu·∫£n tr·ªã vi√™n
        </a>
        <button id="clear-cookies-btn" type="button" class="btn btn-outline" style="margin-left:8px">
          <i class="material-icons">delete</i> X√≥a cookie
        </button>
        <button id="clear-storage-btn" type="button" class="btn btn-outline" style="margin-left:8px">
          <i class="material-icons">delete_sweep</i> X√≥a b·ªô nh·ªõ (local/session)
        </button>
        <button id="refresh-data-btn" type="button" class="btn btn-outline" style="margin-left:8px">
          <i class="material-icons">refresh</i> T·∫£i l·∫°i d·ªØ li·ªáu
        </button>
        <button id="debug-btn" type="button" class="btn btn-outline" style="margin-left:8px">
          <i class="material-icons">bug_report</i> Debug
        </button>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const topicSelect = document.getElementById('topic-select');
        const examSelect = document.getElementById('exam-select');
        const topicInfo = document.getElementById('topic-info');
        const examInfo = document.getElementById('exam-info');
        const topicDescription = document.getElementById('topic-description');
        const examDescription = document.getElementById('exam-description');
        const topicStartBtn = document.getElementById('topic-start-btn');
        const examStartBtn = document.getElementById('exam-start-btn');
        const clearCookiesBtn = document.getElementById('clear-cookies-btn');
        const clearStorageBtn = document.getElementById('clear-storage-btn');
        const refreshDataBtn = document.getElementById('refresh-data-btn');
        const debugBtn = document.getElementById('debug-btn');

        function showEmptyState() {
          topicSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ chuy√™n ƒë·ªÅ --</option>';
          examSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ b√†i thi --</option>';
          topicInfo.style.display = 'none';
          examInfo.style.display = 'none';
          
          // Show error message
          const errorMsg = document.createElement('div');
          errorMsg.id = 'loading-error';
          errorMsg.style.cssText = `
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #f44336;
            text-align: center;
          `;
          errorMsg.innerHTML = `
            <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">error</i>
            Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ c√°c c√°ch sau:
            <br><br>
            <strong>C√°ch 1:</strong> Nh·∫•n n√∫t "T·∫£i l·∫°i d·ªØ li·ªáu" b√™n d∆∞·ªõi
            <br><strong>C√°ch 2:</strong> Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† t·∫£i l·∫°i trang
            <br><strong>C√°ch 3:</strong> X√≥a cache tr√¨nh duy·ªát (Ctrl+F5)
            <br><br>
            <small>N·∫øu v·∫´n kh√¥ng ƒë∆∞·ª£c, li√™n h·ªá qu·∫£n tr·ªã vi√™n: trungnguyenthanh1@agribank.com.vn</small>
          `;
          
          const container = document.querySelector('.content');
          const existingError = document.getElementById('loading-error');
          if (existingError) {
            existingError.remove();
          }
          container.insertBefore(errorMsg, container.firstChild);
        }
        
        function showLoadingState() {
          const loadingMsg = document.createElement('div');
          loadingMsg.id = 'loading-indicator';
          loadingMsg.style.cssText = `
            background: #e3f2fd;
            color: #1976d2;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #2196f3;
            text-align: center;
          `;
          loadingMsg.innerHTML = `
            <i class="material-icons" style="vertical-align: middle; margin-right: 8px; animation: spin 1s linear infinite;">refresh</i>
            ƒêang t·∫£i d·ªØ li·ªáu...
          `;
          
          const container = document.querySelector('.content');
          const existingLoading = document.getElementById('loading-indicator');
          const existingError = document.getElementById('loading-error');
          if (existingLoading) existingLoading.remove();
          if (existingError) existingError.remove();
          container.insertBefore(loadingMsg, container.firstChild);
        }
        
        function hideLoadingState() {
          const loading = document.getElementById('loading-indicator');
          if (loading) loading.remove();
        }

        function clearAllCookies() {
          try {
            const cookies = document.cookie ? document.cookie.split(';') : [];
            const past = 'Thu, 01 Jan 1970 00:00:00 GMT';
            const hostnameParts = location.hostname ? location.hostname.split('.') : [];
            const domains = [''];
            for (let i = 0; i < hostnameParts.length; i++) {
              const d = '.' + hostnameParts.slice(i).join('.');
              if (d !== '.') domains.push(d);
            }
            const paths = Array.from(new Set(['/','/' + location.pathname.split('/').filter(Boolean).join('/')]))
                              .filter(Boolean);

            for (const c of cookies) {
              const eqPos = c.indexOf('=');
              const name = (eqPos > -1 ? c.substr(0, eqPos) : c).trim();
              for (const domain of domains) {
                for (const p of paths) {
                  document.cookie = `${name}=; expires=${past}; path=${p};${domain ? ` domain=${domain};` : ''} SameSite=Lax`;
                }
              }
            }
            alert('ƒê√£ x√≥a t·∫•t c·∫£ cookie c·ªßa trang.');
          } catch (e) {
            alert('Kh√¥ng th·ªÉ x√≥a cookie: ' + (e && e.message ? e.message : e));
          }
        }

        function clearWebStorage() {
          try {
            localStorage.clear();
            sessionStorage.clear();
            alert('ƒê√£ x√≥a localStorage v√† sessionStorage.');
          } catch (e) {
            alert('Kh√¥ng th·ªÉ x√≥a web storage: ' + (e && e.message ? e.message : e));
          }
        }

        if (clearCookiesBtn) {
          clearCookiesBtn.addEventListener('click', clearAllCookies);
        }

        if (clearStorageBtn) {
          clearStorageBtn.addEventListener('click', clearWebStorage);
        }

        if (refreshDataBtn) {
          refreshDataBtn.addEventListener('click', function() {
            // Clear cached data and reload
            localStorage.removeItem('quiz_topics');
            loadTopics();
          });
        }

        if (debugBtn) {
          debugBtn.addEventListener('click', function() {
            // Show debug information
            const debugInfo = {
              userAgent: navigator.userAgent,
              location: window.location.href,
              localStorage: {
                hasQuizTopics: !!localStorage.getItem('quiz_topics'),
                topicsCount: JSON.parse(localStorage.getItem('quiz_topics') || '[]').length
              },
              network: navigator.onLine ? 'Online' : 'Offline',
              screen: {
                width: window.screen.width,
                height: window.screen.height,
                availWidth: window.screen.availWidth,
                availHeight: window.screen.availHeight
              },
              viewport: {
                width: window.innerWidth,
                height: window.innerHeight
              }
            };
            
            const debugModal = document.createElement('div');
            debugModal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.8);
              z-index: 10000;
              display: flex;
              align-items: center;
              justify-content: center;
            `;
            
            debugModal.innerHTML = `
              <div style="
                background: white;
                padding: 20px;
                border-radius: 12px;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                font-family: monospace;
                font-size: 12px;
              ">
                <h3>Debug Information</h3>
                <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
                <button onclick="this.closest('div').parentElement.remove()" style="
                  background: #800020;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  cursor: pointer;
                  margin-top: 10px;
                ">ƒê√≥ng</button>
              </div>
            `;
            
            document.body.appendChild(debugModal);
          });
        }

        function renderLists(all) {
          const exams = all.filter(t => t && (t.isExam === true || (typeof t.durationMinutes === 'number' && t.durationMinutes > 0)));
          const topics = all.filter(t => !(t && (t.isExam === true || (typeof t.durationMinutes === 'number' && t.durationMinutes > 0))));

          // Populate topic dropdown
          if (topics.length > 0) {
            topicSelect.innerHTML = '<option value="">-- Ch·ªçn chuy√™n ƒë·ªÅ --</option>' + 
              topics.map(topic => `<option value="${topic.id}">${topic.name} (${topic.questions ? topic.questions.length : 0} c√¢u)</option>`).join('');
          } else {
            topicSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ chuy√™n ƒë·ªÅ --</option>';
          }

          // Populate exam dropdown
          if (exams.length > 0) {
            examSelect.innerHTML = '<option value="">-- Ch·ªçn b√†i thi --</option>' + 
              exams.map(exam => {
                const total = exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0);
                const duration = exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'N/A';
                return `<option value="${exam.id}">${exam.name} (${total} c√¢u, ${duration})</option>`;
              }).join('');
          } else {
            examSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ b√†i thi --</option>';
          }

          // Populate topic grid
          const topicsContainer = document.getElementById('topics-container');
          if (topicsContainer) {
            topicsContainer.innerHTML = topics.length ? topics.map(topic => `
              <div class="topic-card">
                <div class="topic-card-content">
                  <h3>${topic.name}</h3>
                  <p>${topic.questions ? topic.questions.length : 0} c√¢u h·ªèi</p>
                  <a href="quiz.html?topic=${encodeURIComponent(topic.id)}" class="btn">
                    <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
                  </a>
                </div>
              </div>
            `).join('') : `
              <div class="empty-state">
                <i class="material-icons">folder_open</i>
                <p>Ch∆∞a c√≥ chuy√™n ƒë·ªÅ n√†o</p>
              </div>`;
          }

          // Populate exam grid
          const examsContainer = document.getElementById('exams-container');
          if (examsContainer) {
            examsContainer.innerHTML = exams.length ? exams.map(exam => `
              <div class="topic-card">
                <div class="topic-card-content">
                  <h3>${exam.name}</h3>
                  <p>${exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0)} c√¢u ‚Ä¢ ${exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'N/A'}</p>
                  <a href="quiz.html?topic=${encodeURIComponent(exam.id)}" class="btn">
                    <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
                  </a>
                </div>
              </div>
            `).join('') : `
              <div class="empty-state">
                <i class="material-icons">assignment</i>
                <p>Ch∆∞a c√≥ b√†i thi n√†o</p>
              </div>`;
          }

          // Store data for later use
          window.allTopics = topics;
          window.allExams = exams;
        }

        // View toggle functions
        function toggleTopicView() {
          const dropdownView = document.getElementById('topic-dropdown-view');
          const gridView = document.getElementById('topic-grid-view');
          const toggleBtn = document.getElementById('topic-view-toggle');
          const currentView = localStorage.getItem('index_topic_view') || 'dropdown';
          
          if (currentView === 'dropdown') {
            dropdownView.style.display = 'none';
            gridView.style.display = 'block';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
            localStorage.setItem('index_topic_view', 'grid');
          } else {
            dropdownView.style.display = 'block';
            gridView.style.display = 'none';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
            localStorage.setItem('index_topic_view', 'dropdown');
          }
        }

        function toggleExamView() {
          const dropdownView = document.getElementById('exam-dropdown-view');
          const gridView = document.getElementById('exam-grid-view');
          const toggleBtn = document.getElementById('exam-view-toggle');
          const currentView = localStorage.getItem('index_exam_view') || 'dropdown';
          
          if (currentView === 'dropdown') {
            dropdownView.style.display = 'none';
            gridView.style.display = 'block';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
            localStorage.setItem('index_exam_view', 'grid');
          } else {
            dropdownView.style.display = 'block';
            gridView.style.display = 'none';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
            localStorage.setItem('index_exam_view', 'dropdown');
          }
        }

        function initializeViews() {
          const topicView = localStorage.getItem('index_topic_view') || 'dropdown';
          const examView = localStorage.getItem('index_exam_view') || 'dropdown';
          
          const topicDropdown = document.getElementById('topic-dropdown-view');
          const topicGrid = document.getElementById('topic-grid-view');
          const topicToggleBtn = document.getElementById('topic-view-toggle');
          
          if (topicView === 'grid') {
            topicDropdown.style.display = 'none';
            topicGrid.style.display = 'block';
            topicToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
          } else {
            topicDropdown.style.display = 'block';
            topicGrid.style.display = 'none';
            topicToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
          }
          
          const examDropdown = document.getElementById('exam-dropdown-view');
          const examGrid = document.getElementById('exam-grid-view');
          const examToggleBtn = document.getElementById('exam-view-toggle');
          
          if (examView === 'grid') {
            examDropdown.style.display = 'none';
            examGrid.style.display = 'block';
            examToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
          } else {
            examDropdown.style.display = 'block';
            examGrid.style.display = 'none';
            examToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
          }
        }

        // Initialize views on load
        initializeViews();

        // View toggle event listeners with touch optimization
        document.getElementById('topic-view-toggle').addEventListener('click', toggleTopicView);
        document.getElementById('exam-view-toggle').addEventListener('click', toggleExamView);

        // Add touch optimization for mobile
        if ('ontouchstart' in window) {
          document.body.classList.add('touch-device');
          
          // Optimize button interactions for touch
          document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('touchstart', function() {
              this.style.transform = 'scale(0.95)';
            });
            
            btn.addEventListener('touchend', function() {
              this.style.transform = '';
            });
          });

          // Optimize answer interactions for touch
          document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.answer').forEach(answer => {
              answer.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98)';
              });
              
              answer.addEventListener('touchend', function() {
                this.style.transform = '';
              });
            });
          });
        }

        // Topic selector change handler
        topicSelect.addEventListener('change', function(e) {
          const topicId = e.target.value;
          if (!topicId) {
            topicInfo.style.display = 'none';
            return;
          }
          
          const topic = window.allTopics.find(t => t.id === topicId);
          if (topic) {
            topicDescription.textContent = `${topic.questions ? topic.questions.length : 0} c√¢u h·ªèi ‚Ä¢ Kh√¥ng gi·ªõi h·∫°n th·ªùi gian`;
            topicStartBtn.href = `quiz.html?topic=${encodeURIComponent(topic.id)}`;
            topicInfo.style.display = 'block';
          }
        });

        // Exam selector change handler
        examSelect.addEventListener('change', function(e) {
          const examId = e.target.value;
          if (!examId) {
            examInfo.style.display = 'none';
            return;
          }
          
          const exam = window.allExams.find(t => t.id === examId);
          if (exam) {
            const total = exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0);
            const duration = exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'Kh√¥ng r√µ th·ªùi gian';
            const pauseText = exam.allowPause ? ' ‚Ä¢ Cho ph√©p t·∫°m d·ª´ng' : '';
            examDescription.textContent = `${total} c√¢u h·ªèi ‚Ä¢ ${duration}${pauseText}`;
            examStartBtn.href = `quiz.html?topic=${encodeURIComponent(exam.id)}`;
            examInfo.style.display = 'block';
          }
        });

        async function loadTopics() {
          console.log('Loading topics...');
          showLoadingState();
          
          // Try to load from localStorage first
          try {
            const localTopicsStr = localStorage.getItem('quiz_topics');
            if (localTopicsStr) {
              const localTopics = JSON.parse(localTopicsStr);
              if (Array.isArray(localTopics) && localTopics.length > 0) {
                console.log('Loaded topics from localStorage:', localTopics.length);
                hideLoadingState();
                renderLists(localTopics);
                return;
              }
            }
          } catch (e) {
            console.warn('Error loading from localStorage:', e);
            localStorage.removeItem('quiz_topics'); // Clear corrupted data
          }
          
          // Try to load from remote with multiple fallback strategies
          const urls = [
            './topics.json',
            'topics.json',
            window.location.origin + '/topics.json',
            window.location.href.replace(/\/[^\/]*$/, '/topics.json')
          ];
          
          for (const urlString of urls) {
            try {
              console.log('Trying to load from:', urlString);
              const url = new URL(urlString, location.href);
              url.searchParams.set('v', Date.now());
              
              const resp = await fetch(url, { 
                cache: 'no-store',
                headers: {
                  'Accept': 'application/json'
                }
              });
              
              console.log('Fetch response status:', resp.status, 'for URL:', urlString);
              
              if (resp.ok) {
                const remoteTopics = await resp.json();
                console.log('Remote topics loaded:', remoteTopics);
                
                if (Array.isArray(remoteTopics) && remoteTopics.length > 0) {
                  // Validate topic structure
                  const validTopics = remoteTopics.filter(topic => 
                    topic && 
                    typeof topic.id === 'string' && 
                    typeof topic.name === 'string' &&
                    Array.isArray(topic.questions)
                  );
                  
                  if (validTopics.length > 0) {
                    try {
                      localStorage.setItem('quiz_topics', JSON.stringify(validTopics));
                      console.log('Valid topics saved to localStorage:', validTopics.length);
                    } catch (storageError) {
                      console.warn('Could not save to localStorage:', storageError);
                    }
                    hideLoadingState();
                    renderLists(validTopics);
                    return;
                  } else {
                    console.warn('No valid topics found in remote data');
                  }
                } else {
                  console.warn('Remote topics is not a valid array or is empty');
                }
              } else {
                console.error('Failed to fetch from', urlString, ':', resp.status, resp.statusText);
              }
            } catch(e) {
              console.error('Error loading from', urlString, ':', e);
            }
          }
          
          // Show empty state if all methods fail
          console.log('All loading methods failed, showing empty state');
          hideLoadingState();
          showEmptyState();
        }

        loadTopics();
      });
    </script>

  </div>
  
  <footer class="footer-copyright" style="text-align: center; padding: 20px; margin-top: 40px; background: #f8f6f8; border-top: 1px solid #eee; color: #800020;">
    <strong>B·∫£n quy·ªÅn ¬© 2025 H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II.</strong><br>  
    Li√™n h·ªá: Nguy·ªÖn Th√†nh Trung
    üì± Cellphone: 0947.86.86.82
    üìß Email: trungnguyenthanh1@agribank.com.vn
  </footer>
  
  <script src="mobile-touch.js"></script>
  
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
